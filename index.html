<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Clicker</title>
  <!-- Pages: deploy from main / (root) -->
  <link rel="icon" href="assets/cardinal.png" type="image/png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#0a0a0a',
            neon: {
              cyan: '#00fff7',
              pink: '#ff00aa',
              green: '#00ff88',
              yellow: '#ffff00',
              purple: '#b366ff',
            },
            pixel: { border: '#333', panel: '#1a1a1a' }
          },
          fontFamily: {
            pixel: ['"Press Start 2P"', 'monospace'],
          },
          boxShadow: {
            neon: '0 0 10px currentColor, 0 0 20px currentColor',
            'neon-sm': '0 0 5px currentColor',
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    .pixel-border { border: 3px solid #333; image-rendering: pixelated; }
    .neon-text-cyan { color: #00fff7; text-shadow: 0 0 10px #00fff7; }
    .neon-text-pink { color: #ff00aa; text-shadow: 0 0 10px #ff00aa; }
    .neon-text-green { color: #00ff88; text-shadow: 0 0 10px #00ff88; }
    .page { display: none; min-height: calc(100vh - 120px); }
    .page.active { display: block; }
    .nft-clicker { transition: transform 0.05s; box-shadow: 0 0 20px rgba(0,255,247,0.2), 0 0 40px rgba(255,0,170,0.1); }
    .nft-clicker:hover:not(.cooldown) { box-shadow: 0 0 25px rgba(0,255,247,0.35), 0 0 50px rgba(255,0,170,0.2); }
    .nft-clicker:active { transform: scale(0.97); }
    .nft-clicker.cooldown { opacity: 0.7; pointer-events: none; }
    .image-pixel { image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; }
    /* Loading / intro screen */
    .splash-screen {
      position: fixed; inset: 0; z-index: 9999;
      background: #0a0a0a;
      background-image: radial-gradient(ellipse 80% 70% at 50% 40%, rgba(180,30,50,0.3) 0%, rgba(120,20,40,0.12) 40%, transparent 70%);
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    .splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .splash-card {
      background: #0a0a0a;
      border-radius: 24px;
      padding: 32px 24px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      position: relative;
      border: 2px solid rgba(255,200,50,0.6);
      box-shadow: 0 0 30px rgba(255,180,0,0.4), 0 0 60px rgba(255,140,0,0.2), inset 0 0 0 1px rgba(255,220,100,0.2);
    }
    .splash-card::before {
      content: '';
      position: absolute;
      top: -2px; left: -2px; right: -2px; bottom: -2px;
      border-radius: 26px;
      background: linear-gradient(135deg, #FFD700, #FF8C00, #FFD700);
      z-index: -1;
      opacity: 0.4;
      filter: blur(8px);
    }
    .splash-title { color: #FFD700; font-size: 10px; margin-bottom: 16px; text-shadow: 0 0 12px rgba(255,215,0,0.8); line-height: 1.5; }
    .splash-cardinal { width: 160px; height: auto; margin: 16px auto; border-radius: 12px; image-rendering: pixelated; display: block; }
    .splash-text { color: rgba(255,255,255,0.9); font-size: 9px; line-height: 1.6; margin-bottom: 20px; }
    .splash-btn {
      background: linear-gradient(135deg, #FF8C00, #FFD700);
      color: #000;
      border: none;
      padding: 16px 32px;
      font-size: 10px;
      font-weight: 900;
      border-radius: 50px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      box-shadow: 0 8px 24px rgba(255,180,0,0.5);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .splash-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(255,200,0,0.6); }
    .splash-btn:active { transform: translateY(0); }
    #app.hidden { display: none !important; }

    /* Red radial gradient background */
    body { position: relative; min-height: 100vh; }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse 80% 70% at 50% 40%, rgba(180,30,50,0.35) 0%, rgba(120,20,40,0.15) 40%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    #app { position: relative; z-index: 1; }

    /* Rising tiny stars */
    .stars-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .star {
      position: absolute;
      width: 2px; height: 2px;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      animation: starRise linear infinite;
      box-shadow: 0 0 4px rgba(255,255,255,0.6);
    }
    @keyframes starRise {
      0% { transform: translateY(100vh) translateX(0) scale(1); opacity: 0; }
      8% { opacity: 0.8; }
      92% { opacity: 0.6; }
      100% { transform: translateY(-20px) translateX(0) scale(0.5); opacity: 0; }
    }

    /* Click effect: 8-bit feather */
    .feather-float {
      position: fixed;
      pointer-events: none;
      z-index: 100;
      font-size: 14px;
      opacity: 1;
      animation: featherFloat 1.2s ease-out forwards;
    }
    .feather-float .feather-pixel {
      width: 8px; height: 12px;
      background: linear-gradient(135deg, #e63946, #ff6b6b);
      transform: rotate(var(--r, 0deg));
      border-radius: 1px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.3);
    }
    @keyframes featherFloat {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
      100% { opacity: 0; transform: translateY(-80px) translateX(0) rotate(360deg) scale(0.5); }
    }
    .feather-float.feather-drift-1 { animation: featherFloat1 1.2s ease-out forwards; }
    .feather-float.feather-drift-2 { animation: featherFloat2 1.2s ease-out forwards; }
    .feather-float.feather-drift-3 { animation: featherFloat3 1.2s ease-out forwards; }
    @keyframes featherFloat1 { 0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); } 100% { opacity: 0; transform: translateY(-80px) translateX(-25px) rotate(360deg) scale(0.5); } }
    @keyframes featherFloat2 { 0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); } 100% { opacity: 0; transform: translateY(-80px) translateX(25px) rotate(-300deg) scale(0.5); } }
    @keyframes featherFloat3 { 0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg) scale(1); } 100% { opacity: 0; transform: translateY(-90px) translateX(15px) rotate(280deg) scale(0.5); } }

    /* Click effect: +N token text */
    .tap-value-float {
      position: fixed;
      pointer-events: none;
      z-index: 101;
      font-size: 14px;
      font-weight: 900;
      color: #FFD700;
      text-shadow: 0 0 8px rgba(255,215,0,0.9), 0 1px 2px rgba(0,0,0,0.8);
      animation: valueFloat 1s ease-out forwards;
      transform: translate(-50%, -50%);
    }
    @keyframes valueFloat {
      0% { opacity: 1; transform: translate(-50%, -50%) translateY(0) scale(1.2); }
      70% { opacity: 1; transform: translate(-50%, -50%) translateY(-50px) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) translateY(-70px) scale(0.9); }
    }
  </style>
</head>
<body class="bg-dark text-white font-pixel text-xs md:text-sm antialiased" style="background:#0a0a0a; color:#fff; margin:0; min-height:100vh;">
  <!-- Rising stars layer (behind app) -->
  <div class="stars-layer" id="stars-layer" aria-hidden="true"></div>

  <!-- Loading screen: cardinal + START TAPPING (shown only first visit per session) -->
  <div class="splash-screen hidden" id="splash" style="position:fixed; inset:0; z-index:9999; background:#0a0a0a; display:flex; align-items:center; justify-content:center; padding:20px;">
    <div class="splash-card" style="background:#0a0a0a; border-radius:24px; padding:32px 24px; max-width:380px; width:100%; text-align:center; border:2px solid rgba(255,200,50,0.6);">
      <div class="splash-title" style="color:#FFD700; font-size:10px; margin-bottom:16px;">üî¥ 1N BLOCKCHAIN</div>
      <img src="assets/cardinal.png" alt="Cardinal" class="splash-cardinal image-pixel" style="width:160px; height:auto; margin:16px auto; display:block;" onerror="this.style.display='none'" />
      <p class="splash-text">Tap the Cardinal to earn tokens! Build the community one tap at a time!</p>
      <button type="button" class="splash-btn" id="splash-start">START TAPPING!</button>
    </div>
  </div>

  <div id="app" style="display:block;">
  <!-- Top Bar: 1N BLOCKCHAIN logo + tokens + PVP/bell -->
  <header class="sticky top-0 z-50 bg-black/90 border-b-2 border-pixel-border backdrop-blur-sm">
    <div class="max-w-lg mx-auto px-4 py-2 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2 min-w-0 flex-1">
        <img src="assets/cardinal.png" alt="1N BLOCKCHAIN" class="h-8 md:h-9 object-contain object-left flex-shrink-0" />
        <span class="text-gray-400 shrink-0">TOKENS</span>
        <span id="top-tokens" class="neon-text-cyan font-bold shrink-0">0</span>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <a href="#multiplayer" class="p-2 rounded border-2 border-neon-pink text-neon-pink hover:shadow-neon-sm text-[10px]">PVP</a>
        <button type="button" aria-label="Notifications" class="p-2 rounded border-2 border-gray-500 text-gray-400 hover:border-neon-yellow hover:text-neon-yellow">üîî</button>
      </div>
    </div>
  </header>

  <main class="max-w-lg mx-auto pb-20">
    <!-- Home -->
    <section id="page-home" class="page active p-4">
      <!-- Metric windows above NFT -->
      <div class="grid grid-cols-3 gap-2 mb-4">
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 text-[10px]">CLICKS/S</div>
          <div id="clicks-per-sec" class="neon-text-green">0</div>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 text-[10px]">TOTAL</div>
          <div id="total-clicks" class="neon-text-cyan">0</div>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-2 text-center rounded">
          <div class="text-gray-500 text-[10px]">RATE</div>
          <div id="token-rate" class="neon-text-yellow">1 / 10</div>
        </div>
      </div>
      <!-- NFT Clicker -->
      <div class="flex justify-center">
        <div class="relative inline-block">
          <button
            type="button"
            id="nft-clicker"
            class="nft-clicker w-40 h-40 md:w-52 md:h-52 pixel-border rounded-lg bg-black/80 focus:outline-none focus:ring-2 focus:ring-neon-cyan overflow-hidden"
            aria-label="Click to earn tokens"
          >
            <img src="assets/cardinal.png" alt="NFT Cardinal" class="w-full h-full object-contain image-pixel" />
          </button>
          <div class="absolute bottom-1 right-1 bg-black/80 px-2 py-1 rounded border border-gray-600">
            <span id="click-count-label">0</span> clicks
          </div>
        </div>
      </div>
      <p class="text-center text-gray-500 mt-4">Every 10 clicks = 1 token</p>
      <!-- Stats bar (match reference) -->
      <div class="mt-4 bg-pixel-panel border-2 border-gray-700 rounded px-3 py-2 text-[10px] flex flex-wrap justify-center gap-x-4 gap-y-1">
        <span>Taps: <span id="home-taps" class="text-neon-yellow">0</span></span>
        <span>Tap Power: <span id="home-power" class="text-neon-yellow">1</span>x</span>
        <span>Multiplier: <span id="home-mult" class="text-neon-yellow">1.0</span>x</span>
        <span>Regen: <span id="home-regen" class="text-neon-yellow">1</span>/s</span>
      </div>
      <!-- Badges -->
      <div class="mt-4 text-center">
        <div class="text-gray-500 text-[10px] mb-2">üèÜ BADGES</div>
        <div class="flex justify-center gap-2 flex-wrap">
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel" id="badge-1" title="First Click">üëÜ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-2" title="7-Day Streak">üî•</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-3" title="30-Day Streak">üíé</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-4" title="1K Clicks">üéØ</div>
          <div class="badge-circle w-10 h-10 rounded-full border-2 border-gray-600 flex items-center justify-center text-base bg-pixel-panel opacity-50" id="badge-5" title="10K Clicks">üöÄ</div>
        </div>
      </div>
      <!-- Upgrade strip (match reference) -->
      <div class="mt-4 grid grid-cols-3 gap-2">
        <a href="#boosts" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center hover:border-neon-cyan/50 transition-colors">
          <div class="text-neon-yellow text-base mb-1">‚ö°</div>
          <div class="text-[10px]">Power</div>
          <div class="text-gray-500 text-[10px]">Cost: 50</div>
        </a>
        <a href="#boosts" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center hover:border-neon-green/50 transition-colors">
          <div class="text-neon-green text-base mb-1">üîã</div>
          <div class="text-[10px]">Autoclick</div>
          <div class="text-gray-500 text-[10px]">Cost: 100</div>
        </a>
        <a href="#boosts" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center hover:border-neon-cyan/50 transition-colors">
          <div class="text-neon-cyan text-base mb-1">‚ôªÔ∏è</div>
          <div class="text-[10px]">Regen</div>
          <div class="text-gray-500 text-[10px]">Cost: 75</div>
        </a>
      </div>
    </section>

    <!-- Boosts -->
    <section id="page-boosts" class="page p-4">
      <h2 class="text-neon-cyan mb-4 border-b-2 border-gray-700 pb-2">BOOSTS</h2>
      <p class="text-gray-400 mb-4">Spend tokens on click buffs, autoclickers, and cooldown reductions.</p>
      <div class="space-y-3">
        <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <span>+1 token per 10 clicks (2x)</span>
          <span class="text-neon-yellow">50 tokens</span>
          <button type="button" id="buy-tappower" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="50" data-boost="tapPower">BUY</button>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <span>Autoclicker (1/s)</span>
          <span class="text-neon-yellow">100 tokens</span>
          <button type="button" id="buy-autoclicker" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="100" data-boost="autoclicker">BUY</button>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <span>Shorter cooldown (200ms)</span>
          <span class="text-neon-yellow">75 tokens</span>
          <button type="button" id="buy-cooldown" class="boost-btn border-2 border-neon-cyan text-neon-cyan px-3 py-1 rounded text-[10px] hover:bg-neon-cyan/10 disabled:opacity-50 disabled:cursor-not-allowed" data-cost="75" data-boost="cooldown">BUY</button>
        </div>
      </div>
      <p class="text-gray-500 mt-4 text-[10px]">Your balance: <span id="boosts-balance" class="neon-text-cyan">0</span> tokens</p>
    </section>

    <!-- Bounties -->
    <section id="page-bounties" class="page p-4">
      <h2 class="text-neon-green mb-4 border-b-2 border-gray-700 pb-2">BOUNTIES</h2>
      <p class="text-gray-400 mb-4">Daily rewards, weekly challenges, click milestones.</p>
      <div class="space-y-3">
        <div id="bounty-daily" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <div>
            <div>Daily login</div>
            <div class="text-neon-yellow text-[10px]">Claim: 5 tokens</div>
          </div>
          <button type="button" id="claim-daily" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="daily" data-reward="5">CLAIM</button>
        </div>
        <div id="bounty-100" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <div>
            <div>100 clicks today</div>
            <div class="text-[10px]">Progress: <span id="bounty-100-progress">0</span>/100 ¬∑ Reward: 10 tokens</div>
          </div>
          <button type="button" id="claim-100" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="100today" data-reward="10">CLAIM</button>
        </div>
        <div id="bounty-weekly" class="bg-pixel-panel border-2 border-gray-700 p-3 rounded flex flex-wrap justify-between items-center gap-2">
          <div>
            <div>Weekly: 500 clicks</div>
            <div class="text-[10px]">Progress: <span id="bounty-weekly-progress">0</span>/500 ¬∑ Reward: 50 tokens</div>
          </div>
          <button type="button" id="claim-weekly" class="bounty-claim border-2 border-neon-green text-neon-green px-3 py-1 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50" data-id="weekly" data-reward="50">CLAIM</button>
        </div>
      </div>
      <p class="text-gray-500 mt-4 text-[10px]">Balance: <span id="bounties-balance" class="neon-text-cyan">0</span> tokens</p>
    </section>

    <!-- Friends -->
    <section id="page-friends" class="page p-4">
      <h2 class="text-neon-pink mb-4 border-b-2 border-gray-700 pb-2">FRIENDS</h2>
      <p class="text-gray-400 mb-4">Leaderboard & invite friends.</p>
      <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded mb-4">
        <div class="text-[10px] text-gray-500 mb-2">TOP CLICKERS (by tokens)</div>
        <ol id="leaderboard-list" class="space-y-1 text-[10px]">
          <li>1. Alpha ‚Äî 500 tokens</li>
          <li>2. Beta ‚Äî 300 tokens</li>
          <li>3. You ‚Äî 0 tokens</li>
        </ol>
      </div>
      <button type="button" id="invite-btn" class="w-full py-2 border-2 border-neon-cyan text-neon-cyan rounded hover:bg-neon-cyan/10">COPY INVITE LINK</button>
      <p id="invite-feedback" class="text-neon-green text-[10px] mt-2 hidden">Link copied to clipboard!</p>
      <p class="text-gray-500 mt-2 text-[10px]">Your code: <span id="referral-code" class="neon-text-cyan">------</span></p>
    </section>

    <!-- Wallet -->
    <section id="page-wallet" class="page p-4">
      <h2 class="text-neon-yellow mb-4 border-b-2 border-gray-700 pb-2">WALLET</h2>
      <!-- In-game balance -->
      <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded mb-4">
        <div class="text-gray-500 text-[10px]">IN-GAME BALANCE</div>
        <div id="wallet-balance" class="text-2xl neon-text-cyan">0</div>
        <div class="text-gray-500 text-[10px]">tokens</div>
      </div>
      <!-- TON Wallet + $CARD -->
      <div class="bg-pixel-panel border-2 border-gray-700 p-4 rounded mb-4">
        <div class="text-gray-500 text-[10px] mb-2">TON WALLET</div>
        <p id="wallet-file-warning" class="hidden text-neon-yellow text-[9px] mb-2 p-2 bg-black/50 rounded">Wallet needs the game opened from a URL. Run in project folder: <code class="text-[8px]">npx serve -p 3001</code> then open <code class="text-[8px]">http://localhost:3001</code></p>
        <div id="wallet-connect-area">
          <p id="wallet-connection-status" class="text-[9px] min-h-[14px] mb-2 text-gray-400"></p>
          <div class="mb-2 p-2 rounded border-2 border-neon-green bg-neon-green/10">
            <p class="text-neon-green text-[10px] font-bold">üì± Play & connect on your phone</p>
            <p class="text-white text-[9px] mt-1">Open <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="text-neon-cyan underline">biggleem.github.io/nc-clicker-game-v1</a> in your phone browser. Tap Connect ‚Üí Tonkeeper opens on the same device ‚Üí Approve ‚Üí you‚Äôre connected. No desktop needed.</p>
          </div>
          <button type="button" id="ton-connect-btn" class="w-full py-2 border-2 border-neon-cyan text-neon-cyan rounded hover:bg-neon-cyan/10 text-[10px]">CONNECT WALLET (Tonkeeper / Telegram)</button>
          <p class="text-gray-500 text-[9px] mt-2">1) Tap Connect ‚Üí 2) Approve in Tonkeeper (green button) ‚Üí 3) Return to this tab. We‚Äôll detect the connection automatically, or tap the green button below.</p>
          <p class="text-neon-yellow text-[9px] mt-1">On desktop localhost: run the backend so the wallet can connect. Or use the <a href="https://biggleem.github.io/nc-clicker-game-v1" target="_blank" rel="noopener" class="underline">live site</a>.</p>
          <button type="button" id="ton-check-connection-btn" class="w-full mt-2 py-2 border-2 border-neon-green text-neon-green rounded text-[10px] hover:bg-neon-green/10 font-bold">I approved ‚Äì check connection</button>
        </div>
        <div id="wallet-connected-area" class="hidden">
          <div class="text-[10px] text-gray-400 mb-1">Address</div>
          <div id="ton-address" class="text-neon-green text-[10px] break-all mb-2">‚Äî</div>
          <button type="button" id="ton-disconnect-btn" class="py-1 px-2 border border-gray-500 text-gray-400 rounded text-[10px] hover:bg-gray-800">DISCONNECT</button>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-700">
          <div class="text-gray-500 text-[10px]">$CARD (on-chain)</div>
          <div id="card-balance" class="text-xl neon-text-cyan">‚Äî</div>
          <p class="text-gray-500 text-[10px] mt-1" id="wallet-config-hint">Minter from backend config.</p>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-700" id="withdraw-area">
          <div class="text-gray-500 text-[10px] mb-2">WITHDRAW TO $CARD</div>
          <p class="text-[10px] text-gray-400 mb-2">Convert in-game tokens to on-chain $CARD (sent to your connected wallet).</p>
          <div class="flex gap-2 items-center flex-wrap">
            <input type="number" id="withdraw-amount" min="1" placeholder="Amount" class="bg-black border-2 border-gray-600 rounded px-2 py-2 text-neon-cyan w-24 text-[10px]" />
            <button type="button" id="withdraw-btn" class="border-2 border-neon-green text-neon-green px-3 py-2 rounded text-[10px] hover:bg-neon-green/10 disabled:opacity-50">WITHDRAW</button>
          </div>
          <p id="withdraw-feedback" class="text-[10px] mt-2 hidden"></p>
        </div>
      </div>
      <div class="text-[10px] text-gray-500 mb-2">OWNED NFTS (placeholder)</div>
      <div class="flex gap-2 flex-wrap">
        <div class="w-12 h-12 pixel-border rounded bg-neon-pink/20"></div>
        <div class="w-12 h-12 pixel-border rounded bg-neon-cyan/20"></div>
      </div>
      <div class="mt-4 border-t-2 border-gray-700 pt-4">
        <div class="text-[10px] text-gray-500 mb-2">EXCHANGE</div>
        <p class="text-gray-400 text-[10px]">Swap $CARD for other tokens. Coming after mainnet.</p>
      </div>
    </section>

    <!-- Multiplayer -->
    <section id="page-multiplayer" class="page p-4">
      <h2 class="text-neon-pink mb-4 border-b-2 border-gray-700 pb-2">MULTIPLAYER</h2>
      <p class="text-gray-400 mb-4">Lobby: 2-player rooms. Duel for NFTs.</p>
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center">
          <div class="w-10 h-10 mx-auto pixel-border rounded bg-neon-pink/20 mb-2"></div>
          <div class="text-[10px]">Room 1</div>
          <div class="text-gray-500 text-[10px]">1/2</div>
        </div>
        <div class="bg-pixel-panel border-2 border-gray-700 p-3 rounded text-center">
          <div class="w-10 h-10 mx-auto pixel-border rounded bg-neon-cyan/20 mb-2"></div>
          <div class="text-[10px]">Room 2</div>
          <div class="text-gray-500 text-[10px]">0/2</div>
        </div>
      </div>
      <p class="text-gray-500 mt-4 text-[10px]">Phase 4: join room ‚Üí stake NFT ‚Üí click race ‚Üí winner takes NFT.</p>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 z-50 bg-black/95 border-t-2 border-pixel-border max-w-lg mx-auto">
    <div class="flex justify-around py-2">
      <a href="#home" class="nav-link px-2 py-1 rounded" data-page="home">HOME</a>
      <a href="#boosts" class="nav-link px-2 py-1 rounded" data-page="boosts">BOOSTS</a>
      <a href="#bounties" class="nav-link px-2 py-1 rounded" data-page="bounties">BOUNTIES</a>
      <a href="#friends" class="nav-link px-2 py-1 rounded" data-page="friends">FRIENDS</a>
      <a href="#wallet" class="nav-link px-2 py-1 rounded" data-page="wallet">WALLET</a>
      <a href="#multiplayer" class="nav-link px-2 py-1 rounded" data-page="multiplayer">PVP</a>
    </div>
  </nav>
  </div>

  <script src="ton-config.js"></script>
  <script src="supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url && window.SUPABASE_CONFIG.anonKey && typeof window.supabase !== 'undefined') {
      window.supabaseClient = window.supabase.createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);
    }
  </script>
  <script src="dist/wallet.js" onerror="console.warn('Wallet script failed to load')"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2/dist/tonconnect-ui.min.js"></script>
  <script>
    // --- Constants ---
    const CLICKS_PER_TOKEN = 10;
    const COOLDOWN_BASE_MS = 280;
    const COOLDOWN_REDUCED_MS = 200;

    // --- State (load from localStorage) ---
    let totalClicks = parseInt(localStorage.getItem('tokenClicker_totalClicks') || '0', 10);
    let tokens = parseInt(localStorage.getItem('tokenClicker_tokens') || '', 10);
    if (isNaN(tokens) || tokens < 0) tokens = Math.floor(totalClicks / CLICKS_PER_TOKEN);
    let tapPower = parseInt(localStorage.getItem('tokenClicker_tapPower') || '1', 10);
    let hasAutoclicker = localStorage.getItem('tokenClicker_autoclicker') === '1';
    let hasCooldownBoost = localStorage.getItem('tokenClicker_cooldown') === '1';
    let lastDailyClaim = localStorage.getItem('tokenClicker_lastDailyClaim') || '';
    let claimed100Today = localStorage.getItem('tokenClicker_claimed100Today') === '1';
    let claimedWeekly = localStorage.getItem('tokenClicker_claimedWeekly') === '1';
    let lastDate = localStorage.getItem('tokenClicker_lastDate') || '';
    let clicksToday = parseInt(localStorage.getItem('tokenClicker_clicksToday') || '0', 10);
    let weekStartKey = localStorage.getItem('tokenClicker_weekStart') || '';
    let weeklyClicks = parseInt(localStorage.getItem('tokenClicker_weeklyClicks') || '0', 10);

    let lastClickTime = 0;
    let clicksInLastSecond = 0;
    let lastSecondTime = Date.now();
    let autoclickerInterval = null;

    function todayKey() { return new Date().toISOString().slice(0, 10); }
    function weekKey() {
      const d = new Date();
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(d.setDate(diff));
      return monday.toISOString().slice(0, 10);
    }

    // --- DOM ---
    const nftClicker = document.getElementById('nft-clicker');
    const topTokens = document.getElementById('top-tokens');
    const walletBalance = document.getElementById('wallet-balance');
    const totalClicksEl = document.getElementById('total-clicks');
    const clicksPerSecEl = document.getElementById('clicks-per-sec');
    const tokenRateEl = document.getElementById('token-rate');
    const clickCountLabel = document.getElementById('click-count-label');

    function cooldownMs() { return hasCooldownBoost ? COOLDOWN_REDUCED_MS : COOLDOWN_BASE_MS; }

    function save() {
      localStorage.setItem('tokenClicker_totalClicks', String(totalClicks));
      localStorage.setItem('tokenClicker_tokens', String(tokens));
      localStorage.setItem('tokenClicker_tapPower', String(tapPower));
      localStorage.setItem('tokenClicker_autoclicker', hasAutoclicker ? '1' : '0');
      localStorage.setItem('tokenClicker_cooldown', hasCooldownBoost ? '1' : '0');
      localStorage.setItem('tokenClicker_lastDailyClaim', lastDailyClaim);
      localStorage.setItem('tokenClicker_claimed100Today', claimed100Today ? '1' : '0');
      localStorage.setItem('tokenClicker_claimedWeekly', claimedWeekly ? '1' : '0');
      localStorage.setItem('tokenClicker_lastDate', lastDate);
      localStorage.setItem('tokenClicker_clicksToday', String(clicksToday));
      localStorage.setItem('tokenClicker_weekStart', weekStartKey);
      localStorage.setItem('tokenClicker_weeklyClicks', String(weeklyClicks));
    }

    function updateBountyProgress() {
      const today = todayKey();
      const week = weekKey();
      if (today !== lastDate) {
        clicksToday = 0;
        claimed100Today = false;
        lastDate = today;
      }
      if (week !== weekStartKey) {
        weeklyClicks = 0;
        claimedWeekly = false;
        weekStartKey = week;
      }
    }

    function updateUI() {
      if (topTokens) topTokens.textContent = tokens;
      if (walletBalance) walletBalance.textContent = tokens;
      const boostsBal = document.getElementById('boosts-balance');
      const bountiesBal = document.getElementById('bounties-balance');
      if (boostsBal) boostsBal.textContent = tokens;
      if (bountiesBal) bountiesBal.textContent = tokens;
      if (totalClicksEl) totalClicksEl.textContent = totalClicks;
      if (clickCountLabel) clickCountLabel.textContent = totalClicks;
      if (tokenRateEl) tokenRateEl.textContent = tapPower + ' / 10';
      const homeTaps = document.getElementById('home-taps');
      const homePower = document.getElementById('home-power');
      const homeMult = document.getElementById('home-mult');
      const homeRegen = document.getElementById('home-regen');
      if (homeTaps) homeTaps.textContent = totalClicks;
      if (homePower) homePower.textContent = tapPower;
      if (homeMult) homeMult.textContent = '1.0';
      if (homeRegen) homeRegen.textContent = hasAutoclicker ? '1' : '0';
      updateBadges();
      updateBoostsUI();
      updateBountiesUI();
      updateLeaderboard();
    }

    function updateBadges() {
      [['badge-1', totalClicks >= 1], ['badge-2', false], ['badge-3', false], ['badge-4', totalClicks >= 1000], ['badge-5', totalClicks >= 10000]].forEach(([id, unlocked]) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.toggle('opacity-50', !unlocked);
        el.classList.toggle('border-neon-yellow', !!unlocked);
        el.classList.toggle('border-gray-600', !unlocked);
      });
    }

    function updateBoostsUI() {
      document.querySelectorAll('.boost-btn').forEach(btn => {
        const cost = parseInt(btn.dataset.cost, 10);
        const boost = btn.dataset.boost;
        const owned = (boost === 'tapPower' && tapPower >= 2) || (boost === 'autoclicker' && hasAutoclicker) || (boost === 'cooldown' && hasCooldownBoost);
        btn.disabled = owned || tokens < cost;
        btn.textContent = owned ? 'OWNED' : 'BUY';
      });
    }

    function updateBountiesUI() {
      updateBountyProgress();
      const today = todayKey();
      const dailyClaimBtn = document.getElementById('claim-daily');
      const dailyCanClaim = lastDailyClaim !== today;
      if (dailyClaimBtn) {
        dailyClaimBtn.disabled = !dailyCanClaim;
        dailyClaimBtn.textContent = dailyCanClaim ? 'CLAIM' : 'CLAIMED';
      }
      const p100 = document.getElementById('bounty-100-progress');
      if (p100) p100.textContent = clicksToday;
      const claim100Btn = document.getElementById('claim-100');
      if (claim100Btn) {
        claim100Btn.disabled = clicksToday < 100 || claimed100Today;
        claim100Btn.textContent = claimed100Today ? 'CLAIMED' : 'CLAIM';
      }
      const pWeek = document.getElementById('bounty-weekly-progress');
      if (pWeek) pWeek.textContent = weeklyClicks;
      const claimWeekBtn = document.getElementById('claim-weekly');
      if (claimWeekBtn) {
        claimWeekBtn.disabled = weeklyClicks < 500 || claimedWeekly;
        claimWeekBtn.textContent = claimedWeekly ? 'CLAIMED' : 'CLAIM';
      }
      save();
    }

    function updateLeaderboard() {
      let leaderboard = [];
      try {
        leaderboard = JSON.parse(localStorage.getItem('tokenClicker_leaderboard') || '[]');
      } catch (_) {}
      if (!Array.isArray(leaderboard) || leaderboard.length === 0) {
        leaderboard = [ { name: 'Alpha', tokens: 500 }, { name: 'Beta', tokens: 300 } ];
      }
      const me = leaderboard.find(e => e.name === 'You');
      if (me) me.tokens = tokens; else leaderboard.push({ name: 'You', tokens });
      leaderboard.sort((a, b) => b.tokens - a.tokens);
      try { localStorage.setItem('tokenClicker_leaderboard', JSON.stringify(leaderboard)); } catch (_) {}
      const list = document.getElementById('leaderboard-list');
      if (list) {
        list.innerHTML = leaderboard.slice(0, 10).map((e, i) =>
          (i + 1) + '. ' + e.name + ' ‚Äî ' + e.tokens + ' tokens'
        ).join('\n');
      }
      let refCode = localStorage.getItem('tokenClicker_refCode');
      if (!refCode) {
        refCode = 'REF' + Math.random().toString(36).slice(2, 8).toUpperCase();
        localStorage.setItem('tokenClicker_refCode', refCode);
      }
      const refEl = document.getElementById('referral-code');
      if (refEl) refEl.textContent = refCode;
    }

    function updateClicksPerSecond() {
      const now = Date.now();
      if (now - lastSecondTime >= 1000) {
        clicksInLastSecond = 0;
        lastSecondTime = now;
      }
      if (clicksPerSecEl) clicksPerSecEl.textContent = clicksInLastSecond;
    }

    function addTokens(amount) {
      tokens += amount;
      updateUI();
      save();
    }

    function onValidClick() {
      const now = Date.now();
      if (now - lastClickTime < cooldownMs()) return -1;
      lastClickTime = now;

      totalClicks++;
      const prevEffective = (totalClicks - 1) * tapPower;
      const newEffective = totalClicks * tapPower;
      const earned = Math.floor(newEffective / CLICKS_PER_TOKEN) - Math.floor(prevEffective / CLICKS_PER_TOKEN);
      tokens += earned;

      const nowSec = now / 1000;
      if (Math.floor(nowSec) > Math.floor(lastSecondTime / 1000)) {
        lastSecondTime = now;
        clicksInLastSecond = 0;
      }
      clicksInLastSecond++;

      const today = todayKey();
      const week = weekKey();
      if (today !== lastDate) { clicksToday = 0; claimed100Today = false; lastDate = today; }
      if (week !== weekStartKey) { weeklyClicks = 0; claimedWeekly = false; weekStartKey = week; }
      clicksToday++;
      weeklyClicks++;

      updateUI();
      save();
      updateClicksPerSecond();
      return earned;
    }

    function spawnClickEffects(earned) {
      const btn = nftClicker;
      const rect = btn.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;

      for (let i = 0; i < 5; i++) {
        const el = document.createElement('div');
        el.className = 'feather-float feather-drift-' + (1 + (i % 3));
        el.style.left = cx + (Math.random() - 0.5) * 24 + 'px';
        el.style.top = cy + (Math.random() - 0.5) * 24 + 'px';
        el.style.setProperty('--r', (Math.random() * 120 - 60) + 'deg');
        el.innerHTML = '<div class="feather-pixel"></div>';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1300);
      }

      const valueEl = document.createElement('div');
      valueEl.className = 'tap-value-float';
      valueEl.textContent = '+1';
      valueEl.style.left = cx + 'px';
      valueEl.style.top = cy + 'px';
      document.body.appendChild(valueEl);
      setTimeout(() => valueEl.remove(), 1100);
    }

    if (nftClicker) nftClicker.addEventListener('click', (e) => {
      nftClicker.classList.add('cooldown');
      const earned = onValidClick();
      if (earned >= 0) spawnClickEffects(earned);
      setTimeout(() => nftClicker.classList.remove('cooldown'), cooldownMs());
    });

    // Boosts: buy
    document.querySelectorAll('.boost-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const cost = parseInt(btn.dataset.cost, 10);
        const boost = btn.dataset.boost;
        if (tokens < cost) return;
        if (boost === 'tapPower' && tapPower < 2) { tokens -= cost; tapPower = 2; }
        if (boost === 'autoclicker' && !hasAutoclicker) { tokens -= cost; hasAutoclicker = true; startAutoclicker(); }
        if (boost === 'cooldown' && !hasCooldownBoost) { tokens -= cost; hasCooldownBoost = true; }
        updateUI();
        save();
      });
    });

    function startAutoclicker() {
      if (autoclickerInterval) return;
      autoclickerInterval = setInterval(() => {
        totalClicks++;
        const prevEffective = (totalClicks - 1) * tapPower;
        const newEffective = totalClicks * tapPower;
        tokens += Math.floor(newEffective / CLICKS_PER_TOKEN) - Math.floor(prevEffective / CLICKS_PER_TOKEN);
        const today = todayKey();
        const week = weekKey();
        if (today !== lastDate) { clicksToday = 0; lastDate = today; }
        if (week !== weekStartKey) { weeklyClicks = 0; weekStartKey = week; }
        clicksToday++;
        weeklyClicks++;
        updateUI();
        save();
      }, 1000);
    }
    if (hasAutoclicker) startAutoclicker();

    // Bounties: claim
    document.querySelectorAll('.bounty-claim').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const reward = parseInt(btn.dataset.reward, 10);
        if (id === 'daily' && lastDailyClaim !== todayKey()) { lastDailyClaim = todayKey(); addTokens(reward); }
        if (id === '100today' && clicksToday >= 100 && !claimed100Today) { claimed100Today = true; addTokens(reward); }
        if (id === 'weekly' && weeklyClicks >= 500 && !claimedWeekly) { claimedWeekly = true; addTokens(reward); }
        updateBountiesUI();
      });
    });

    // Friends: copy invite link
    const inviteBtn = document.getElementById('invite-btn');
    const inviteFeedback = document.getElementById('invite-feedback');
    if (inviteBtn) {
      inviteBtn.addEventListener('click', () => {
        const code = localStorage.getItem('tokenClicker_refCode') || 'REF0000';
        const url = window.location.origin + window.location.pathname + '?ref=' + encodeURIComponent(code);
        navigator.clipboard.writeText(url).then(() => {
          if (inviteFeedback) { inviteFeedback.classList.remove('hidden'); setTimeout(() => inviteFeedback.classList.add('hidden'), 2000); }
        });
      });
    }

    // TON Wallet: connector + optional TonConnect UI modal; we prefer direct connect + link for reliability
    var walletStatusEl = document.getElementById('wallet-connection-status');
    function setWalletStatus(msg, isError) {
      if (walletStatusEl) { walletStatusEl.textContent = msg || ''; walletStatusEl.className = 'text-[9px] min-h-[14px] mb-2 ' + (isError ? 'text-neon-pink' : 'text-gray-400'); }
    }
    let tonConnectUI = null;
    if (window.TonWallet && typeof TON_CONNECT_UI !== 'undefined') {
      try {
        tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ connector: window.TonWallet.getConnector() });
        window.tonConnectUI = tonConnectUI;
        if (tonConnectUI.onStatusChange) tonConnectUI.onStatusChange(function() { updateWalletUI(); setWalletStatus(''); });
      } catch (e) { console.warn('TonConnect UI init:', e); }
    }
    var lastCardBalanceFetch = 0;
    function fetchCardBalanceFromBackend() {
      const TW = window.TonWallet;
      const backendUrl = (window.TON_CONFIG && window.TON_CONFIG.backendUrl) || '';
      if (!TW || !backendUrl) return;
      const addr = TW.getAddress();
      if (!addr) return;
      if (Date.now() - lastCardBalanceFetch < 15000) return;
      lastCardBalanceFetch = Date.now();
      fetch(backendUrl.replace(/\/$/, '') + '/api/wallet/card-balance?address=' + encodeURIComponent(addr))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data && data.balance != null && TW.setCardBalance) TW.setCardBalance(data.balance);
          updateWalletUI();
        })
        .catch(function() { updateWalletUI(); });
    }
    function updateWalletUI() {
      const TW = window.TonWallet;
      if (!TW) return;
      const addr = TW.getAddress();
      const connectArea = document.getElementById('wallet-connect-area');
      const connectedArea = document.getElementById('wallet-connected-area');
      const tonAddress = document.getElementById('ton-address');
      const cardBalanceEl = document.getElementById('card-balance');
      if (connectArea) connectArea.classList.toggle('hidden', !!addr);
      if (connectedArea) connectedArea.classList.toggle('hidden', !addr);
      if (tonAddress && addr) tonAddress.textContent = addr.slice(0, 8) + '‚Ä¶' + addr.slice(-8);
      if (cardBalanceEl) {
        if (TW.cardBalance != null && TW.cardBalance !== undefined) {
          cardBalanceEl.textContent = String(TW.cardBalance);
        } else {
          cardBalanceEl.textContent = addr ? '‚Ä¶' : '‚Äî';
        }
      }
      if (addr) fetchCardBalanceFromBackend();
    }
    const tonConnectBtn = document.getElementById('ton-connect-btn');
    const tonDisconnectBtn = document.getElementById('ton-disconnect-btn');
    var connectionPollTimer = null;
    function startConnectionPolling() {
      if (connectionPollTimer) return;
      setWalletStatus('Waiting for approval‚Ä¶ Return to this tab after approving in Tonkeeper.');
      var attempts = 0;
      var maxAttempts = 40;
      function poll() {
        if (window.TonWallet && window.TonWallet.getAddress()) {
          connectionPollTimer = null;
          setWalletStatus('');
          updateWalletUI();
          return;
        }
        attempts++;
        if (attempts >= maxAttempts) {
          connectionPollTimer = null;
          setWalletStatus('No connection yet. Click "I approved ‚Äì check connection" or try again.');
          return;
        }
        var unPause = window.TonWallet && window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') unPause().catch(function() {});
        window.TonWallet.restoreConnection().then(function() {
          updateWalletUI();
          if (window.TonWallet.getAddress()) { connectionPollTimer = null; setWalletStatus(''); return; }
          connectionPollTimer = setTimeout(poll, 2000);
        }).catch(function() { connectionPollTimer = setTimeout(poll, 2000); });
      }
      if (window.TonWallet && window.TonWallet.unPauseConnection) {
        window.TonWallet.unPauseConnection().then(function() { poll(); }).catch(function() { poll(); });
      } else {
        poll();
      }
    }
    if (tonConnectBtn) {
      tonConnectBtn.addEventListener('click', function() {
        if (!window.TonWallet) { setWalletStatus('Wallet script not loaded.', true); return; }
        setWalletStatus('Opening Tonkeeper‚Ä¶');
        tonConnectBtn.disabled = true;
        window.TonWallet.connect()
          .then(function() {
            updateWalletUI();
            if (window.TonWallet.getAddress()) { setWalletStatus(''); tonConnectBtn.disabled = false; return; }
            startConnectionPolling();
            tonConnectBtn.disabled = false;
          })
          .catch(function(err) {
            var msg = (err && err.message) || 'Connect failed';
            if (msg.indexOf('POPUP_BLOCKED') !== -1) msg = 'Popup blocked. Allow popups for this site or use the link that opened.';
            setWalletStatus(msg, true);
            tonConnectBtn.disabled = false;
          });
      });
    }
    const tonCheckBtn = document.getElementById('ton-check-connection-btn');
    if (tonCheckBtn && window.TonWallet) {
      tonCheckBtn.addEventListener('click', function() {
        if (connectionPollTimer) { clearTimeout(connectionPollTimer); connectionPollTimer = null; }
        const origText = tonCheckBtn.textContent;
        tonCheckBtn.disabled = true;
        tonCheckBtn.textContent = 'Checking‚Ä¶';
        setWalletStatus('Checking connection‚Ä¶');
        var unPause = window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') Promise.resolve(unPause()).catch(function() {});
        function done() {
          updateWalletUI();
          tonCheckBtn.disabled = false;
          tonCheckBtn.textContent = origText;
          setWalletStatus('');
        }
        var attempts = 0;
        var maxAttempts = 12;
        function poll() {
          window.TonWallet.restoreConnection()
            .then(function() {
              updateWalletUI();
              if (window.TonWallet.getAddress()) { done(); return; }
              attempts++;
              if (attempts < maxAttempts) {
                tonCheckBtn.textContent = 'Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')';
                setWalletStatus('Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')');
                setTimeout(poll, 1500);
              } else {
                tonCheckBtn.textContent = 'Not yet. Try again or refresh.';
                tonCheckBtn.disabled = false;
                setWalletStatus('No connection yet. Approve in Tonkeeper and try again.');
              }
            })
            .catch(function() {
              updateWalletUI();
              if (window.TonWallet.getAddress()) { done(); return; }
              attempts++;
              if (attempts < maxAttempts) {
                tonCheckBtn.textContent = 'Checking‚Ä¶ (' + attempts + '/' + maxAttempts + ')';
                setTimeout(poll, 1500);
              } else {
                tonCheckBtn.textContent = 'Try again or refresh page.';
                tonCheckBtn.disabled = false;
                setWalletStatus('Try again or refresh.');
              }
            });
        }
        poll();
      });
    }
    if (tonDisconnectBtn && window.TonWallet) {
      tonDisconnectBtn.addEventListener('click', () => {
        window.TonWallet.disconnect();
        updateWalletUI();
      });
    }
    if (window.TonWallet) {
      const fileWarning = document.getElementById('wallet-file-warning');
      if (fileWarning && (typeof location !== 'undefined' && location.protocol === 'file:')) {
        fileWarning.classList.remove('hidden');
      }
      window.TonWallet.onStatusChange(updateWalletUI);
      window.TonWallet.restoreConnection().then(() => {
        updateWalletUI();
      }).catch(() => { updateWalletUI(); });
      // When user returns to this tab after approving in Tonkeeper, unpause bridge and sync
      window.addEventListener('focus', function() {
        if (!window.TonWallet) return;
        var unPause = window.TonWallet.unPauseConnection;
        if (typeof unPause === 'function') {
          unPause().then(function() {
            window.TonWallet.restoreConnection().then(updateWalletUI).catch(updateWalletUI);
          }).catch(function() { updateWalletUI(); });
        }
      });
    }

    // Backend config: load minter address (and network) from backend
    const backendUrl = (window.TON_CONFIG && window.TON_CONFIG.backendUrl) || '';
    if (backendUrl) {
      fetch(backendUrl.replace(/\/$/, '') + '/api/config')
        .then(r => r.json())
        .then(data => {
          if (data.cardMinterAddress && window.TonWallet) {
            window.TonWallet.setCardMinterAddress(data.cardMinterAddress);
          }
          const hint = document.getElementById('wallet-config-hint');
          if (hint) hint.textContent = data.cardMinterAddress ? 'Minter: ' + data.cardMinterAddress.slice(0, 8) + '‚Ä¶' : 'Set backendUrl in ton-config.js and add minter to backend .env';
        })
        .catch(() => {});
    }

    // Withdraw: send in-game tokens to backend, backend mints $CARD to user
    const withdrawAmount = document.getElementById('withdraw-amount');
    const withdrawBtn = document.getElementById('withdraw-btn');
    const withdrawFeedback = document.getElementById('withdraw-feedback');
    if (withdrawBtn && backendUrl) {
      withdrawBtn.addEventListener('click', async () => {
        const amount = withdrawAmount ? parseInt(withdrawAmount.value, 10) : 0;
        if (!amount || amount < 1) { withdrawFeedback.textContent = 'Enter amount (1+).'; withdrawFeedback.classList.remove('hidden'); return; }
        const addr = window.TonWallet && window.TonWallet.getAddress();
        if (!addr) { withdrawFeedback.textContent = 'Connect wallet first.'; withdrawFeedback.classList.remove('hidden'); return; }
        if (tokens < amount) { withdrawFeedback.textContent = 'Not enough in-game balance.'; withdrawFeedback.classList.remove('hidden'); return; }
        withdrawBtn.disabled = true;
        withdrawFeedback.textContent = 'Sending‚Ä¶';
        withdrawFeedback.classList.remove('hidden');
        withdrawFeedback.classList.remove('text-neon-green', 'text-neon-pink');
        try {
          const res = await fetch(backendUrl.replace(/\/$/, '') + '/api/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: addr, amount }),
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.success) {
            tokens -= amount;
            save();
            updateUI();
            withdrawFeedback.textContent = 'Withdraw sent! Check your wallet for $CARD.';
            withdrawFeedback.classList.add('text-neon-green');
            if (withdrawAmount) withdrawAmount.value = '';
          } else {
            withdrawFeedback.textContent = data.error || 'Withdraw failed.';
            withdrawFeedback.classList.add('text-neon-pink');
          }
        } catch (e) {
          withdrawFeedback.textContent = e.message || 'Network error.';
          withdrawFeedback.classList.add('text-neon-pink');
        }
        withdrawBtn.disabled = false;
      });
    } else if (document.getElementById('withdraw-area')) {
      document.getElementById('withdraw-area').querySelector('.text-[10px]').textContent = 'Set backendUrl in ton-config.js to enable withdraw.';
    }

    document.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });
    setInterval(updateClicksPerSecond, 200);

    // Routing
    function getPageFromHash() {
      const hash = (window.location.hash || '#home').slice(1).toLowerCase();
      return hash === '' ? 'home' : hash;
    }
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const el = document.getElementById('page-' + pageId);
      if (el) el.classList.add('active');
      document.querySelectorAll('.nav-link').forEach(a => {
        a.classList.toggle('text-neon-cyan', a.getAttribute('data-page') === pageId);
        a.classList.toggle('text-gray-400', a.getAttribute('data-page') !== pageId);
      });
    }
    window.addEventListener('hashchange', () => showPage(getPageFromHash()));

    // Loading screen: show app when user taps START TAPPING
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    const splashStart = document.getElementById('splash-start');
    function startGame() {
      if (splash) splash.classList.add('hidden');
      if (app) app.classList.remove('hidden');
      updateBountyProgress();
      save();
      showPage(getPageFromHash());
      updateUI();
    }
    if (splashStart) splashStart.addEventListener('click', startGame);

    function createStars() {
      const layer = document.getElementById('stars-layer');
      if (!layer) return;
      for (let i = 0; i < 45; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.animationDuration = (4 + Math.random() * 6) + 's';
        star.style.animationDelay = Math.random() * 8 + 's';
        layer.appendChild(star);
      }
    }

    window.addEventListener('load', () => {
      createStars();
      updateBountyProgress();
      save();
      showPage(getPageFromHash());
      updateUI();
    });
  </script>
</body>
</html>
